name: Android Debug Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android-debug:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install deps
        run: npm install --legacy-peer-deps

      - name: Ensure Capacitor deps (idempotent)
        run: |
          npm install @capacitor/android --legacy-peer-deps
          npm install @capacitor-community/speech-recognition --legacy-peer-deps || true

      # ðŸ”´ Usa il bundle legacy estratto dall'APK funzionante
      - name: Usa bundle web legacy (pre-rottura)
        run: |
          rm -rf www
          mkdir -p www
          cp -R legacy_www_final/* www/
          echo "Legacy web bundle copiato in www/"

      - name: Aggiungi/sincronizza piattaforma Android
        run: npx cap add android || npx cap sync android

      - name: Sanity check (index + assets)
        run: |
          test -f android/app/src/main/assets/public/index.html
          ls -l android/app/src/main/assets/public/assets | head

      - name: Gradle build (debug)
        working-directory: ./android
        run: |
          chmod +x ./gradlew
          ./gradlew clean assembleDebug

      - name: Upload APK (android-build)
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: android/app/build/outputs/apk/debug/*.apk
          if-no-files-found: warn
