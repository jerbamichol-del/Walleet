<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestore Spese - Nuovo Inizio</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#4f46e5" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" crossorigin src="./assets/index-14_62MMU.js"></script>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <!-- Pulsante per test microfono -->
    <div class="p-4">
      <button onclick="startMicrofono()" class="bg-blue-600 text-white px-4 py-2 rounded">
        Avvia Microfono
      </button>
    </div>

    <!-- Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registrato con scope:', reg.scope))
            .catch(err => console.error('SW registration failed:', err));
        });
      }
    </script>

    <!-- Script microfono con log diretto in Termux + debug -->
    <script type="module">
      import { SpeechRecognition } from '@capacitor-community/speech-recognition';
      import { Filesystem, Directory } from '@capacitor/filesystem';

      // Percorso log (Termux)
      const logFilePath = '/data/data/com.termux/files/home/Walleet/log_microfono.txt';

      async function writeLog(msg) {
        console.log('[DEBUG LOG] ' + msg); // log sempre visibile nella console
        try {
          await Filesystem.appendFile({
            path: logFilePath,
            data: msg + '\n',
            directory: Directory.Data, // scrive in filesystem locale Capacitor
            recursive: true
          });
          console.log('[DEBUG LOG] Scrittura file riuscita');
        } catch (e) {
          console.error('[DEBUG LOG] Errore scrittura file:', e);
        }
      }

      async function startMicrofono() {
        try {
          console.log('[DEBUG] startMicrofono chiamato');
          await writeLog('[Microfono] startMicrofono chiamato');

          const available = await SpeechRecognition.available();
          await writeLog('[Microfono] Disponibile: ' + available);
          console.log('[DEBUG] Disponibile:', available);

          if (!available) {
            await writeLog('[Microfono] Plugin non disponibile.');
            return;
          }

          const permission = await SpeechRecognition.requestPermission();
          await writeLog('[Microfono] Permesso: ' + permission);
          console.log('[DEBUG] Permesso:', permission);

          if (permission !== 'granted') {
            await writeLog('[Microfono] Permesso negato.');
            return;
          }

          const result = await SpeechRecognition.start({ language: 'it-IT' });
          await writeLog('[Microfono] Risultato riconoscimento: ' + JSON.stringify(result));
          console.log('[DEBUG] Risultato riconoscimento:', result);

        } catch (error) {
          await writeLog('[Microfono] Errore rilevato: ' + error);
          console.error('[DEBUG] Errore rilevato:', error);
        }
      }

      window.startMicrofono = startMicrofono;
    </script>
  </body>
</html>
